<!DOCTYPE html>
<html>
<head>
    <title>Direct Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Direct Component Test</h1>
        <button class="btn btn-primary" id="testBtn">Test Start Simulation</button>
        <div id="status" class="mt-3"></div>
        <div id="log" class="mt-3 p-3 bg-light" style="height: 300px; overflow-y: auto;"></div>
    </div>

    <script>
        function log(msg) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }

        function updateStatus(msg) {
            document.getElementById('status').innerHTML = `<div class="alert alert-info">${msg}</div>`;
        }

        // Load scripts sequentially
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function initializeComponents() {
            try {
                log('Loading simulator.js...');
                await loadScript('js/simulator.js');
                log('✅ simulator.js loaded');

                log('Testing CavitySimulator...');
                const sim = new CavitySimulator();
                log('✅ CavitySimulator created');

                log('Loading charts.js...');
                await loadScript('js/charts.js');
                log('✅ charts.js loaded');

                log('Testing ChartManager...');
                const chartManager = new ChartManager();
                log('✅ ChartManager created');

                log('Loading main.js...');
                await loadScript('js/main.js');
                log('✅ main.js loaded');

                // Now test the start button simulation
                document.getElementById('testBtn').onclick = function() {
                    try {
                        log('=== TESTING START SIMULATION ===');
                        
                        // Create a minimal app-like object
                        const testApp = {
                            simulator: sim,
                            chartManager: chartManager,
                            updateSimulatorParameters: function() {
                                log('Updating simulator parameters...');
                                this.simulator.setRFParameters(1.0, 0, -460, 0.008);
                            },
                            updateStatus: function(status) {
                                log(`Status: ${status}`);
                                updateStatus(status);
                            }
                        };

                        log('Calling updateSimulatorParameters...');
                        testApp.updateSimulatorParameters();

                        log('Calling simulator.start()...');
                        testApp.simulator.start();

                        log('Updating status...');
                        testApp.updateStatus('Simulation running...');

                        // Check if it's actually running
                        setTimeout(() => {
                            if (testApp.simulator.running) {
                                log('✅ Simulator is running!');
                                log(`Data points generated: ${testApp.simulator.data_buffer.length}`);
                                
                                if (testApp.simulator.data_buffer.length > 0) {
                                    const latest = testApp.simulator.data_buffer[testApp.simulator.data_buffer.length - 1];
                                    log(`Latest cavity voltage: ${latest.vc_magnitude} MV`);
                                    log(`Latest forward power: ${latest.forward_power} kW`);
                                }
                            } else {
                                log('❌ Simulator is not running');
                            }
                        }, 2000);

                    } catch (error) {
                        log(`❌ Error during start simulation test: ${error.message}`);
                        console.error(error);
                    }
                };

                log('=== ALL COMPONENTS LOADED SUCCESSFULLY ===');
                updateStatus('All components loaded. Click "Test Start Simulation" to test.');

            } catch (error) {
                log(`❌ Error loading components: ${error.message}`);
                updateStatus(`Error: ${error.message}`);
                console.error(error);
            }
        }

        // Capture all errors
        window.addEventListener('error', function(e) {
            log(`❌ GLOBAL ERROR: ${e.message} at ${e.filename}:${e.lineno}`);
        });

        // Start initialization when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeComponents);
    </script>
</body>
</html>
