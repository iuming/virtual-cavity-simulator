name: Deploy GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Allow manual triggering
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install sphinx sphinx-rtd-theme sphinx-autodoc-typehints
          pip install myst-parser
          pip install -r requirements.txt || true
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Create documentation structure
        run: |
          mkdir -p docs_build
          # Copy web application to docs_build if it exists
          if [ -d "web" ]; then
            cp -r web/* docs_build/
            echo "Web simulator copied to docs_build"
          else
            echo "Web directory not found, creating placeholder"
          fi
          
      - name: Generate project documentation
        run: |
          # Create a comprehensive documentation site
          python -c "
          import os
          import shutil
          from datetime import datetime
          
          # Create docs structure
          os.makedirs('docs_build', exist_ok=True)
          
          # Generate index.html
          index_content = '''<!DOCTYPE html>
          <html lang=\"en\">
          <head>
              <meta charset=\"UTF-8\">
              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
              <title>Virtual Cavity RF Simulator</title>
              <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css\" rel=\"stylesheet\">
              <link href=\"https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css\" rel=\"stylesheet\">
              <style>
                  .hero-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 80px 0; }
                  .feature-card { transition: transform 0.3s; }
                  .feature-card:hover { transform: translateY(-5px); }
                  .code-block { background: #f8f9fa; border-left: 4px solid #007bff; padding: 15px; margin: 20px 0; }
                  .nav-pills .nav-link.active { background-color: #007bff; }
                  .screenshot { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
              </style>
          </head>
          <body>
              <nav class=\"navbar navbar-expand-lg navbar-dark bg-dark fixed-top\">
                  <div class=\"container\">
                      <a class=\"navbar-brand\" href=\"#\">üî¨ Virtual Cavity RF Simulator</a>
                      <button class=\"navbar-toggler\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#navbarNav\">
                          <span class=\"navbar-toggler-icon\"></span>
                      </button>
                      <div class=\"collapse navbar-collapse\" id=\"navbarNav\">
                          <ul class=\"navbar-nav ms-auto\">
                              <li class=\"nav-item\"><a class=\"nav-link\" href=\"#features\">Features</a></li>
                              <li class=\"nav-item\"><a class=\"nav-link\" href=\"#installation\">Installation</a></li>
                              <li class=\"nav-item\"><a class=\"nav-link\" href=\"#usage\">Usage</a></li>
                              <li class=\"nav-item\"><a class=\"nav-link\" href=\"#api\">API</a></li>
                              <li class=\"nav-item\"><a class=\"nav-link\" href=\"https://github.com/iuming/virtual-cavity-simulator\" target=\"_blank\">GitHub</a></li>
                          </ul>
                      </div>
                  </div>
              </nav>
          
              <section class=\"hero-section text-center\">
                  <div class=\"container\">
                      <h1 class=\"display-4 fw-bold mb-4\">Virtual Cavity RF Simulator</h1>
                      <p class=\"lead mb-4\">A comprehensive Radio Frequency cavity simulation platform with advanced graphical interface for accelerator physics applications</p>
                      <div class=\"d-flex justify-content-center gap-3\">
                          <a href=\"https://github.com/iuming/virtual-cavity-simulator\" class=\"btn btn-light btn-lg\">
                              <i class=\"fab fa-github\"></i> View on GitHub
                          </a>
                          <a href=\"#installation\" class=\"btn btn-outline-light btn-lg\">Get Started</a>
                      </div>
                      <div class=\"mt-4\">
                          <img src=\"https://img.shields.io/badge/python-3.8%2B-blue.svg\" alt=\"Python Version\"> 
                          <img src=\"https://img.shields.io/badge/license-MIT-green.svg\" alt=\"License\">
                          <img src=\"https://img.shields.io/badge/platform-Windows%20%7C%20Linux%20%7C%20macOS-lightgrey.svg\" alt=\"Platform\">
                          <img src=\"https://img.shields.io/badge/status-Active-brightgreen.svg\" alt=\"Status\">
                      </div>
                  </div>
              </section>
          
              <section id=\"features\" class=\"py-5\">
                  <div class=\"container\">
                      <h2 class=\"text-center mb-5\">üåü Key Features</h2>
                      <div class=\"row g-4\">
                          <div class=\"col-md-6 col-lg-3\">
                              <div class=\"card h-100 feature-card border-0 shadow\">
                                  <div class=\"card-body text-center\">
                                      <div class=\"mb-3\" style=\"font-size: 3rem;\">üéõÔ∏è</div>
                                      <h5 class=\"card-title\">Real-time Control</h5>
                                      <p class=\"card-text\">Multi-parameter control interface with precision sliders for amplitude, phase, frequency, and beam current.</p>
                                  </div>
                              </div>
                          </div>
                          <div class=\"col-md-6 col-lg-3\">
                              <div class=\"card h-100 feature-card border-0 shadow\">
                                  <div class=\"card-body text-center\">
                                      <div class=\"mb-3\" style=\"font-size: 3rem;\">üìä</div>
                                      <h5 class=\"card-title\">Advanced Visualization</h5>
                                      <p class=\"card-text\">Multi-curve dynamic display with real-time plotting of cavity voltage, reflection, detuning, and mechanical modes.</p>
                                  </div>
                              </div>
                          </div>
                          <div class=\"col-md-6 col-lg-3\">
                              <div class=\"card h-100 feature-card border-0 shadow\">
                                  <div class=\"card-body text-center\">
                                      <div class=\"mb-3\" style=\"font-size: 3rem;\">üîç</div>
                                      <h5 class=\"card-title\">Data Analysis</h5>
                                      <p class=\"card-text\">Historical data recording, playback, export in CSV/JSON formats with 10,000+ data points capacity.</p>
                                  </div>
                              </div>
                          </div>
                          <div class=\"col-md-6 col-lg-3\">
                              <div class=\"card h-100 feature-card border-0 shadow\">
                                  <div class=\"card-body text-center\">
                                      <div class=\"mb-3\" style=\"font-size: 3rem;\">üß™</div>
                                      <h5 class=\"card-title\">Parameter Scanning</h5>
                                      <p class=\"card-text\">Automated parameter sweeping with custom ranges and 20-point response curve generation.</p>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </section>
          
              <section id=\"installation\" class=\"py-5 bg-light\">
                  <div class=\"container\">
                      <h2 class=\"text-center mb-5\">üöÄ Quick Start</h2>
                      <div class=\"row\">
                          <div class=\"col-lg-8 mx-auto\">
                              <div class=\"code-block\">
                                  <h5>Installation</h5>
                                  <pre><code class=\"language-bash\"># Clone the repository
          git clone https://github.com/iuming/virtual-cavity-simulator.git
          cd virtual-cavity-simulator
          
          # Install dependencies
          pip install -r requirements.txt
          
          # Launch the GUI
          python launch_gui.py</code></pre>
                              </div>
                          </div>
                      </div>
                  </div>
              </section>
          
              <section id=\"usage\" class=\"py-5\">
                  <div class=\"container\">
                      <h2 class=\"text-center mb-5\">üìñ Usage Examples</h2>
                      <div class=\"row\">
                          <div class=\"col-lg-6\">
                              <h4>Basic Simulation</h4>
                              <div class=\"code-block\">
                                  <pre><code class=\"language-python\">from examples.basic_simulation import basic_cavity_simulation
          
          # Run basic simulation
          time_data, vc_data, vr_data, detuning = basic_cavity_simulation()
          
          print(f\"Average cavity voltage: {np.mean(np.abs(vc_data))*1e-6:.2f} MV\")</code></pre>
                              </div>
                          </div>
                          <div class=\"col-lg-6\">
                              <h4>GUI Application</h4>
                              <div class=\"code-block\">
                                  <pre><code class=\"language-bash\"># Launch full-featured GUI
          python launch_gui.py
          
          # Or run standalone simulation
          python sim_cavity_standalone.py</code></pre>
                              </div>
                          </div>
                      </div>
                  </div>
              </section>
          
              <section id=\"api\" class=\"py-5 bg-light\">
                  <div class=\"container\">
                      <h2 class=\"text-center mb-5\">üîß Technical Specifications</h2>
                      <div class=\"row\">
                          <div class=\"col-md-6\">
                              <h4>Simulation Parameters</h4>
                              <ul class=\"list-group list-group-flush\">
                                  <li class=\"list-group-item\"><strong>Time Resolution:</strong> 1 Œºs time steps</li>
                                  <li class=\"list-group-item\"><strong>Cavity Frequency:</strong> 1.3 GHz (configurable)</li>
                                  <li class=\"list-group-item\"><strong>Quality Factor:</strong> 3√ó10‚Å∂ (loaded)</li>
                                  <li class=\"list-group-item\"><strong>Mechanical Modes:</strong> 5 modes (280-618 Hz)</li>
                                  <li class=\"list-group-item\"><strong>Beam Parameters:</strong> 0-20 mA variable current</li>
                              </ul>
                          </div>
                          <div class=\"col-md-6\">
                              <h4>Performance Metrics</h4>
                              <ul class=\"list-group list-group-flush\">
                                  <li class=\"list-group-item\"><strong>Real-time Performance:</strong> 1000+ simulations/second</li>
                                  <li class=\"list-group-item\"><strong>Memory Usage:</strong> <100MB for typical operations</li>
                                  <li class=\"list-group-item\"><strong>Data Capacity:</strong> 10,000+ data points</li>
                                  <li class=\"list-group-item\"><strong>Platform Support:</strong> Windows, Linux, macOS</li>
                                  <li class=\"list-group-item\"><strong>Simulation Accuracy:</strong> <1% error validated</li>
                              </ul>
                          </div>
                      </div>
                  </div>
              </section>
          
              <footer class=\"bg-dark text-light py-4\">
                  <div class=\"container\">
                      <div class=\"row\">
                          <div class=\"col-md-6\">
                              <h5>Virtual Cavity RF Simulator</h5>
                              <p>Developed by Ming Liu<br>
                              Institute of High Energy Physics, Chinese Academy of Sciences</p>
                          </div>
                          <div class=\"col-md-6 text-md-end\">
                              <h5>Links</h5>
                              <a href=\"https://github.com/iuming/virtual-cavity-simulator\" class=\"text-light me-3\">GitHub</a>
                              <a href=\"https://github.com/iuming/virtual-cavity-simulator/issues\" class=\"text-light me-3\">Issues</a>
                              <a href=\"https://github.com/iuming/virtual-cavity-simulator/blob/main/docs/installation.md\" class=\"text-light\">Documentation</a>
                              <div class=\"mt-2\">
                                  <small>¬© 2025 Ming Liu. Licensed under MIT License.</small>
                              </div>
                          </div>
                      </div>
                  </div>
              </footer>
          
              <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js\"></script>
              <script src=\"https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js\"></script>
              <script src=\"https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js\"></script>
          </body>
          </html>'''
          
          with open('docs_build/index.html', 'w', encoding='utf-8') as f:
              f.write(index_content)
          
          print('Generated project website')
          "
          
      - name: Convert README to HTML
        run: |
          python -c "
          import re
          
          # Read README.md
          with open('README.md', 'r', encoding='utf-8') as f:
              readme_content = f.read()
          
          # Simple markdown to HTML conversion for key sections
          html_content = '''<!DOCTYPE html>
          <html>
          <head>
              <title>Virtual Cavity RF Simulator - Documentation</title>
              <meta charset=\"UTF-8\">
              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
              <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css\" rel=\"stylesheet\">
              <style>
                  body { padding-top: 60px; }
                  .navbar-brand { font-weight: bold; }
                  pre { background: #f8f9fa; padding: 15px; border-radius: 5px; }
                  .content { max-width: 900px; margin: 0 auto; }
              </style>
          </head>
          <body>
              <nav class=\"navbar navbar-expand-lg navbar-dark bg-primary fixed-top\">
                  <div class=\"container\">
                      <a class=\"navbar-brand\" href=\"index.html\">üî¨ Virtual Cavity RF Simulator</a>
                      <div class=\"navbar-nav ms-auto\">
                          <a class=\"nav-link\" href=\"index.html\">Home</a>
                          <a class=\"nav-link\" href=\"documentation.html\">Documentation</a>
                          <a class=\"nav-link\" href=\"https://github.com/iuming/virtual-cavity-simulator\">GitHub</a>
                      </div>
                  </div>
              </nav>
              <div class=\"container content\">
                  <div class=\"row\">
                      <div class=\"col-12\">
          ''' + readme_content.replace('```', '</pre>').replace('```', '<pre>').replace('#', '<h1>').replace('##', '</h1><h2>').replace('###', '</h2><h3>').replace('####', '</h3><h4>') + '''
                      </div>
                  </div>
              </div>
          </body>
          </html>'''
          
          with open('docs_build/documentation.html', 'w', encoding='utf-8') as f:
              f.write(html_content)
          
          print('Generated documentation page')
          "
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs_build

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
